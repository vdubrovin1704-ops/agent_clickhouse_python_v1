# Комплексный ИИ-агент: ClickHouse + Python Analysis

Интеллектуальный агент для анализа данных, который объединяет возможности работы с базой данных ClickHouse и Python-анализа с визуализацией.

## 🎯 Возможности

- 🗄️ **Прямое подключение к ClickHouse** - выгрузка данных из базы данных
- 📊 **Python анализ** - обработка данных с помощью pandas, numpy
- 📈 **Визуализация** - построение графиков с matplotlib и seaborn
- 💬 **История диалога** - сохранение контекста разговора в SQLite
- 🤖 **Claude Sonnet 4** - мощная языковая модель от Anthropic
- 📦 **Формат Parquet** - сохранение сложных типов данных ClickHouse

## 🚀 Быстрый старт

### 1. Установка зависимостей

```bash
# Создать виртуальное окружение
python3 -m venv venv
source venv/bin/activate

# Установить зависимости
pip install -r requirements.txt
```

### 2. Настройка конфигурации

```bash
# Копировать шаблон
cp .env.example .env

# Отредактировать .env и заполнить:
# - ANTHROPIC_API_KEY
# - CLICKHOUSE_HOST, CLICKHOUSE_USER, CLICKHOUSE_PASSWORD
nano .env
```

### 3. Скачать SSL сертификат (для Яндекс Cloud)

```bash
wget https://storage.yandexcloud.net/cloud-certs/CA.pem -O YandexInternalRootCA.crt
```

### 4. Запустить тестовый агент

```bash
python test_agent.py
```

## 📝 Примеры запросов

```
❓ Покажи список всех таблиц в базе данных

❓ Выгрузи первые 100 записей из таблицы orders

❓ Покажи топ-10 товаров по выручке за последний месяц и построй bar chart

❓ Посчитай общую выручку по месяцам за 2024 год и построй line chart

❓ Проанализируй данные и покажи основные статистические показатели
```

## 🏗️ Архитектура

```
┌─────────────────┐
│  Пользователь   │
└────────┬────────┘
         │ Запрос на естественном языке
         ▼
┌─────────────────┐
│  Claude Sonnet 4│
│   (Anthropic)   │
└────────┬────────┘
         │ Решает какие tools вызвать
         ▼
┌─────────────────────────────────┐
│     Composite Agent             │
│  ┌─────────────────────────┐   │
│  │   list_tables           │   │ Получить схему БД
│  │   clickhouse_query      │   │ Выгрузить данные → Parquet
│  │   python_analysis       │   │ Анализ + графики
│  └─────────────────────────┘   │
└─────────────────────────────────┘
         │
         ▼
┌──────────────────────────────────┐
│  Результат:                      │
│  • Текстовый ответ (Markdown)    │
│  • Графики (base64 PNG)          │
│  • Таблицы                       │
└──────────────────────────────────┘
```

## 📁 Структура файлов

```
agent_clickhouse_python_v1/
├── config.py                   # Конфигурация
├── clickhouse_client.py        # Клиент ClickHouse
├── python_sandbox.py           # Выполнение Python кода
├── chat_storage.py             # История чатов (SQLite)
├── tools.py                    # Определения tools для Claude
├── composite_agent.py          # Главный агент
├── test_agent.py               # Тестовый файл
├── requirements.txt            # Зависимости
├── .env.example                # Шаблон конфигурации
├── INSTALLATION.md             # Подробная инструкция
└── README.md                   # Этот файл
```

## 🔧 Технологии

- **Python 3.11+**
- **Claude Sonnet 4** (через Anthropic SDK)
- **ClickHouse** (через clickhouse-connect)
- **Pandas, NumPy** (анализ данных)
- **Matplotlib, Seaborn** (визуализация)
- **SQLite** (история диалога)
- **Parquet** (формат данных)

## 📖 Подробная документация

Смотрите [INSTALLATION.md](INSTALLATION.md) для:
- Подробной инструкции по установке на Ubuntu
- Примеров использования
- Устранения проблем
- Следующих шагов (API сервер, веб-интерфейс)

## 💡 Как это работает

1. **Пользователь** пишет запрос на русском языке
2. **Claude** анализирует запрос и решает:
   - Нужно ли посмотреть схему БД? → `list_tables`
   - Нужно ли выгрузить данные? → `clickhouse_query`
   - Нужно ли проанализировать/визуализировать? → `python_analysis`
3. **Агент** выполняет необходимые инструменты:
   - Выгружает данные из ClickHouse в Parquet
   - Выполняет Python код для анализа
   - Захватывает графики matplotlib
4. **Claude** формирует понятный ответ с выводами
5. **История** сохраняется для продолжения диалога

## 🎨 Особенности

### Почему Parquet, а не CSV?

ClickHouse имеет сложные типы данных:
- `Array(String)` - массивы
- `Map(String, UInt64)` - словари
- `Tuple(Int32, String)` - кортежи

CSV не может корректно сохранить эти типы, а Parquet сохраняет их нативно.

### Автоматический retry при ошибках

Если Python код упал с ошибкой, Claude **видит ошибку** и **автоматически исправляет код** в следующей итерации.

### Скользящее окно истории

Для каждой сессии хранится только последние 20 сообщений, что:
- Экономит место в БД
- Сохраняет актуальный контекст
- Предотвращает раздувание контекста Claude

## 🔐 Безопасность

- SQL инъекции предотвращены (только SELECT запросы)
- Python код выполняется в изолированном namespace
- База данных доступна только для чтения
- SSL подключение к ClickHouse

## 📊 Примеры работы

### Запрос: "Покажи топ-10 товаров по выручке"

**Что делает агент:**
1. Вызывает `list_tables` чтобы узнать структуру
2. Вызывает `clickhouse_query` с SQL:
   ```sql
   SELECT product_name, SUM(revenue) as total_revenue
   FROM orders
   GROUP BY product_name
   ORDER BY total_revenue DESC
   LIMIT 10
   ```
3. Вызывает `python_analysis` для создания bar chart
4. Возвращает таблицу и график

### Запрос: "Построй line chart продаж по месяцам"

**Что делает агент:**
1. Выгружает данные с агрегацией по месяцам
2. Создает график с matplotlib
3. Подписывает оси на русском языке
4. Форматирует числа с разделителями тысяч
5. Возвращает график и анализ

## 🚧 Следующие шаги

После тестирования агента можно добавить:

- [ ] FastAPI сервер для HTTP API
- [ ] Веб-интерфейс для общения с агентом
- [ ] Systemd сервис для автозапуска
- [ ] Docker контейнер для деплоя
- [ ] Расширенная аналитика (ML модели)

## 📄 Спецификация

Полная спецификация реализации находится в файле [FULL_IMPLEMENTATION_SPEC.md](FULL_IMPLEMENTATION_SPEC.md)

## 🤝 Вклад

Этот проект создан на основе:
- **CLI агент ClickHouse** - работа с базой данных
- **Julius v2** - Python анализ и графики

Объединение двух агентов в один мощный инструмент для анализа данных.

## 📞 Поддержка

Если возникли вопросы или проблемы:
1. Проверьте [INSTALLATION.md](INSTALLATION.md)
2. Посмотрите логи в консоли
3. Создайте Issue в GitHub

---

**Создано с использованием Claude Sonnet 4** 🤖
